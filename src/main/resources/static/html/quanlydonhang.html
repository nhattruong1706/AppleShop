<!DOCTYPE html>
<html lang="vi" ng-app="adminApp">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<div ng-controller="AdminOrderController as vm" class="container py-4">

    <h2 class="mb-4 text-center">üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>

    <div class="d-flex justify-content-between mb-3">
        <h4>üì¶ Danh s√°ch ƒë∆°n h√†ng</h4>
        <button class="btn btn-danger btn-sm" ng-click="vm.deleteCancelledOrders()">üóë X√≥a t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ h·ªßy</button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle text-center">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>ƒê·ªãa ch·ªâ giao</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="order in vm.orders">
                    <td>{{order.id}}</td>
                    <td>{{order.userName || '-'}}</td>
                    <td>{{order.totalAmount | currency:'‚Ç´':0}}</td>
                    <td>
                        <div ng-if="order.street || order.city">{{order.street}}, {{order.city}}</div>
                        <div ng-if="!order.street && !order.city">-</div>
                    </td>
                    <td>
                        <span class="badge bg-warning text-dark" ng-if="order.status === 'PENDING'">Ch·ªù x√°c nh·∫≠n</span>
                        <span class="badge bg-success" ng-if="order.status === 'CONFIRMED'">ƒê√£ x√°c nh·∫≠n</span>
                        <span class="badge bg-info text-dark" ng-if="order.status === 'SHIPPING'">ƒêang giao h√†ng</span>
                        <span class="badge bg-primary" ng-if="order.status === 'SUCCESS'">Ho√†n th√†nh</span>
                        <span class="badge bg-danger" ng-if="order.status === 'CANCELLED'">ƒê√£ h·ªßy</span>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm me-1"
                                ng-if="order.status === 'PENDING'"
                                ng-click="vm.updateStatus(order.id, 'CONFIRMED')">‚úî X√°c nh·∫≠n</button>
                        <button class="btn btn-info btn-sm text-white me-1"
                                ng-if="order.status === 'CONFIRMED'"
                                ng-click="vm.updateStatus(order.id, 'SHIPPING')">üöö Giao h√†ng</button>
                        <button class="btn btn-primary btn-sm me-1"
                                ng-if="order.status === 'SHIPPING'"
                                ng-click="vm.updateStatus(order.id, 'SUCCESS')">‚úÖ Ho√†n th√†nh</button>
                        <button class="btn btn-danger btn-sm me-1"
                                ng-if="order.status !== 'CANCELLED' && order.status !== 'SUCCESS'"
                                ng-click="vm.cancelOrder(order.id)">‚úñ H·ªßy</button>

                        <!-- N√∫t xem s·∫£n ph·∫©m variant -->
                        <button class="btn btn-secondary btn-sm" ng-click="vm.showOrderItems(order.id)">üëÅÔ∏è Xem</button>
                    </td>
                </tr>
                <tr ng-if="vm.orders.length === 0">
                    <td colspan="6" class="text-muted py-3">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal xem s·∫£n ph·∫©m c·ªßa ƒë∆°n -->
    <div class="modal fade" id="orderItemsModal" tabindex="-1" aria-labelledby="orderItemsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üõí Chi ti·∫øt ƒë∆°n h√†ng #{{vm.selectedOrderId}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered align-middle text-center">
                        <thead>
                        <tr>
                            <th>·∫¢nh</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th>Variant</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√°</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="item in vm.selectedOrderItems">
                            <td>
                                <img ng-src="{{item.variantImg}}" alt="variant" width="60">

                            </td>
                            <td>{{item.productName}}</td>
                            <td>{{item.variantName}}</td>
                            <td>{{item.qty}}</td>
                            <td>{{item.price | currency:'‚Ç´':0}}</td>
                        </tr>
                        <tr ng-if="!vm.selectedOrderItems.length">
                            <td colspan="5" class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    angular.module('adminApp', [])
        .controller('AdminOrderController', ['$http', '$timeout', function($http, $timeout) {
            const vm = this;
            vm.orders = [];
            vm.selectedOrderItems = [];
            vm.selectedOrderId = null;

            // üîπ Load t·∫•t c·∫£ ƒë∆°n h√†ng
            vm.loadOrders = function() {
                $http.get('http://localhost:8080/api/orders/all')
                    .then(resp => { vm.orders = resp.data; })
                    .catch(err => console.error('‚ùå L·ªói khi load ƒë∆°n h√†ng:', err));
            };

            // üîπ C·∫≠p nh·∫≠t tr·∫°ng th√°i
            vm.updateStatus = function(orderId, newStatus) {
                if (!confirm(`X√°c nh·∫≠n chuy·ªÉn tr·∫°ng th√°i ƒë∆°n h√†ng sang ${newStatus}?`)) return;
                $http.put(`http://localhost:8080/api/orders/${orderId}/status?status=${newStatus}`)
                    .then(resp => { alert(resp.data.message || '‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng'); vm.loadOrders(); })
                    .catch(err => { alert('‚ùå L·ªói!'); console.error(err); });
            };

            // üîπ H·ªßy ƒë∆°n h√†ng
            vm.cancelOrder = function(orderId) {
                if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y kh√¥ng?')) return;
                $http.put(`http://localhost:8080/api/orders/${orderId}/cancel`)
                    .then(resp => { alert(resp.data.message || '‚úÖ ƒê√£ h·ªßy'); vm.loadOrders(); })
                    .catch(err => { alert('‚ùå L·ªói!'); console.error(err); });
            };

            // üîπ X√≥a t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ h·ªßy
            vm.deleteCancelledOrders = function() {
                if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ h·ªßy kh√¥ng?')) return;
                $http.delete('http://localhost:8080/api/orders/cancelled')
                    .then(resp => { alert(resp.data.message || '‚úÖ ƒê√£ x√≥a'); vm.loadOrders(); })
                    .catch(err => { alert('‚ùå L·ªói!'); console.error(err); });
            };

            // üîπ Xem chi ti·∫øt ƒë∆°n h√†ng
            vm.showOrderItems = function(orderId) {
                vm.selectedOrderId = orderId;
                vm.selectedOrderItems = [];
                $http.get(`http://localhost:8080/api/orders/${orderId}/variants`)
                    .then(resp => { vm.selectedOrderItems = resp.data; })
                    .catch(err => { alert('‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c s·∫£n ph·∫©m'); console.error(err); });
                // M·ªü modal sau 100ms ƒë·ªÉ Angular bind xong
                $timeout(() => { new bootstrap.Modal(document.getElementById('orderItemsModal')).show(); }, 100);
            };

            // üîπ Load d·ªØ li·ªáu ban ƒë·∫ßu
            vm.loadOrders();
        }]);
</script>

</body>
</html>
