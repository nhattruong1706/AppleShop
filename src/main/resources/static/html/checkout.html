<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp" ng-controller="CheckoutCtrl as vm">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t h√†ng - AppleShop</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        body {
            background: linear-gradient(#0f1724, #111827);
            color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            padding-top: 40px;
        }
        h3 { color: #fbbf24; }

        /* B·∫£ng s·∫£n ph·∫©m */
        .table {
            background-color: #1f2937 !important;
            color: #f3f4f6 !important;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #374151 !important;
        }
        .table th { background-color: #506aa2 !important; color: #fff !important; text-align: center; padding: 12px; border-bottom: 1px solid #374151 !important; }
        .table td { background-color: #1f2937 !important; color: #f3f4f6 !important; text-align: center; padding: 12px; border-bottom: 1px solid #374151 !important; border-right: 1px solid #374151 !important; }
        .table td:last-child { border-right: none; }
        .table tbody tr:nth-child(even) td { background-color: #1e293b !important; }
        .table tbody tr:hover td { background-color: #324360 !important; color: #fff !important; }

        /* Dropdown ƒë·ªãa ch·ªâ & payment */
        .form-select { background-color: #1f2937 !important; color: #f3f4f6 !important; border: 1px solid #374151 !important; }
        .form-select option { background-color: #1f2937; color: #f3f4f6; }

        /* N√∫t ƒë·∫∑t h√†ng */
        .btn-success { background-color: #5672b3; border: none; }
        .btn-success:hover { background-color: #3b5a9c; }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1055;
        }
        .toast {
            background-color: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 10px;
            min-width: 250px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            opacity: 0.95;
        }
        .toast-success { border-left: 5px solid #22c55e; }
        .toast-error { border-left: 5px solid #ef4444; }
        .toast-warning { border-left: 5px solid #facc15; }
    </style>
</head>
<body class="container py-4">

<div class="header-container" ng-include="'/html/header.html'"></div>
<h3 class="mb-3">üõí X√°c nh·∫≠n ƒë∆°n h√†ng</h3>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Kh√¥ng c√≥ s·∫£n ph·∫©m -->
<div ng-if="vm.items.length === 0">
    <div class="alert alert-warning">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ ƒë·∫∑t h√†ng.</div>
    <a href="/cart.html" class="btn btn-secondary">‚¨Ö Quay l·∫°i gi·ªè h√†ng</a>
</div>

<!-- C√≥ s·∫£n ph·∫©m -->
<div ng-if="vm.items.length > 0">
    <table class="table table-bordered align-middle">
        <thead>
        <tr>
            <th>S·∫£n ph·∫©m</th>
            <th>·∫¢nh</th>
            <th class="text-center">S·ªë l∆∞·ª£ng</th>
            <th class="text-end">ƒê∆°n gi√°</th>
            <th class="text-end">T·ªïng</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="i in vm.items">
            <td>{{ i.variant.variantName }}</td>
            <td class="text-center">
                <img ng-src="{{ i.variant.img }}" alt="{{ i.variant.variantName }}" style="width:80px; height:80px; border-radius:8px;">
            </td>
            <td class="text-center">{{ i.qty }}</td>
            <td class="text-end">{{ i.variant.price | currency:'‚Ç´' }}</td>
            <td class="text-end">{{ i.variant.price * i.qty | currency:'‚Ç´' }}</td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
            <th colspan="4" class="text-end">T·ªïng c·ªông:</th>
            <th class="text-end text-danger h5">{{ vm.getTotal() | currency:'‚Ç´' }}</th>
        </tr>
        </tfoot>
    </table>

    <!-- ƒê·ªãa ch·ªâ -->
    <div class="mt-4">
        <h5>üìç ƒê·ªãa ch·ªâ giao h√†ng</h5>
        <div class="d-flex align-items-center mb-2">
            <select class="form-select w-75 me-2" ng-model="vm.selectedAddressId"
                    ng-options="a.id as (a.recipientName + ' - ' + a.street + ', ' + a.city) for a in vm.addresses">
                <option value="">-- Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng --</option>
            </select>
            <a href="/html/address.html" class="btn btn-outline-primary">‚ûï Th√™m ƒë·ªãa ch·ªâ</a>
        </div>

        <div class="mt-3" ng-if="vm.selectedAddressId">
            <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> {{ vm.getSelectedAddress().recipientName }}</p>
            <p><strong>SƒêT:</strong> {{ vm.getSelectedAddress().phone }}</p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> {{ vm.getSelectedAddress().street }}, {{ vm.getSelectedAddress().city }}</p>
        </div>
    </div>

    <!-- Thanh to√°n -->
    <div class="mt-4">
        <h5>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
        <select class="form-select w-75" ng-model="vm.selectedPaymentId"
                ng-options="p.id as p.name for p in vm.payments track by p.id">
            <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n --</option>
        </select>
    </div>

    <button class="btn btn-success mt-4 px-4" ng-click="vm.confirmOrder()">‚úÖ X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
    <a href="/html/cart.html" class="btn btn-outline-secondary mt-4 ms-2">‚¨Ö Quay l·∫°i gi·ªè h√†ng</a>
</div>

<script>
    angular.module('appleShopApp', [])
        .controller('CheckoutCtrl', ['$http', '$window', '$timeout', function($http, $window, $timeout){
            const vm = this;

            // S·∫£n ph·∫©m t·ª´ localStorage
            vm.items = JSON.parse(localStorage.getItem("checkoutItems") || "[]");

            vm.addresses = [];
            vm.payments = [];
            vm.selectedAddressId = null;
            vm.selectedPaymentId = null;

            // T√≠nh t·ªïng ti·ªÅn
            vm.getTotal = () => vm.items.reduce((sum, i) => sum + i.variant.price * i.qty, 0);

            // L·∫•y ƒë·ªãa ch·ªâ, ch·ªçn m·∫∑c ƒë·ªãnh n·∫øu c√≥
            function loadAddresses(){
                $http.get("/api/addresses/me").then(res=>{
                    vm.addresses = res.data || [];
                    const defaultAddr = vm.addresses.find(a => a.isDefault);
                    if(defaultAddr) vm.selectedAddressId = defaultAddr.id;
                }).catch(err => showToast("L·ªói khi l·∫•y ƒë·ªãa ch·ªâ", "error"));
            }

            // L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n
            function loadPayments(){
                $http.get("/api/payments").then(res=>{
                    vm.payments = (res.data || [])
                        .filter(p=>p && p.id != null && p.name)
                        .map(p=>({id:p.id, name:p.name}));
                    if(!vm.payments.find(p=>p.id===0)) vm.payments.push({id:0,name:"Thanh to√°n khi nh·∫≠n h√†ng (COD)"});
                }).catch(err=>{
                    vm.payments = [{id:0,name:"Thanh to√°n khi nh·∫≠n h√†ng (COD)"}];
                    showToast("L·ªói khi l·∫•y ph∆∞∆°ng th·ª©c thanh to√°n","error");
                });
            }

            // L·∫•y object address
            vm.getSelectedAddress = function(){
                return vm.addresses.find(a => a.id === vm.selectedAddressId);
            };

            // Toast
            function showToast(msg,type="success"){
                const container = document.getElementById("toastContainer");
                const toast = document.createElement("div");
                toast.className = `toast toast-${type}`;
                toast.innerText = msg;
                container.appendChild(toast);
                $timeout(()=>container.removeChild(toast),3000);
            }

            // X√°c nh·∫≠n ƒë·∫∑t h√†ng
            vm.confirmOrder = function(){
                const selectedAddress = vm.getSelectedAddress();
                const selectedPayment = vm.payments.find(p=>p.id===vm.selectedPaymentId);

                if(!selectedAddress){ showToast("‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ!","warning"); return; }
                if(!selectedPayment){ showToast("‚ö†Ô∏è Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!","warning"); return; }

                const orderData = {
                    addressId: selectedAddress.id,
                    paymentMethodId: selectedPayment.id,
                    items: vm.items.map(i=>({variantId:i.variant.id, qty:i.qty})),
                    payment: selectedPayment.id === 0 ? {paymentStatus:"UNPAID", paymentMethod:"COD", paymentDate:new Date().toISOString()} : {}
                };

                $http.post("/api/orders/create", orderData).then(res=>{
                    showToast("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!","success");
                    localStorage.removeItem("checkoutItems");
                    $timeout(()=>$window.location.href="/html/order.html",1000);
                }).catch(err=>{
                    showToast("‚ùå ƒê·∫∑t h√†ng th·∫•t b·∫°i: " + (err.data?.message||"Kh√¥ng r√µ nguy√™n nh√¢n"),"error");
                });
            };

            loadAddresses();
            loadPayments();
        }]);
</script>
<script src="/js/header.js"></script>
</body>
</html>
