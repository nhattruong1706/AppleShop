<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp" ng-controller="UserOrderController as vm">
<head>
    <meta charset="UTF-8">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        body {
            background: linear-gradient(#0f1724, #111827);
            color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            padding-top: 40px;
        }

        .container h2 {
            color: #fbbf24;
            text-align: center;
            margin-bottom: 30px;
        }

        /* B·∫£ng n·ªÅn t·ªëi */
        .table {
            background-color: #1f2937 !important;
            color: #f3f4f6 !important;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #374151 !important;
        }

        .table th {
            background-color: #506aa2 !important;
            color: #fff !important;
            text-align: center;
            padding: 12px;
            border-bottom: 1px solid #374151 !important;
        }

        .table td {
            background-color: #1f2937 !important;
            color: #f3f4f6 !important;
            text-align: center;
            padding: 12px;
            border-bottom: 1px solid #374151 !important;
            border-right: 1px solid #374151 !important;
        }

        .table td:last-child {
            border-right: none;
        }

        .table tbody tr:nth-child(even) td {
            background-color: #1e293b !important;
        }

        .table tbody tr:hover td {
            background-color: #324360 !important;
            color: #fff !important;
        }

        /* Badge tr·∫°ng th√°i */
        .badge {
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .badge.bg-warning { background-color: #facc15; color: #1f2937; }
        .badge.bg-success { background-color: #22c55e; }
        .badge.bg-info { background-color: #38bdf8; color: #1f2937; }
        .badge.bg-primary { background-color: #5672b3; }
        .badge.bg-danger { background-color: #ef4444; }

        /* N√∫t Xem / H·ªßy */
        .btn-outline-primary {
            background-color: #5672b3 !important;
            color: #fff !important;
            border: none !important;
            border-radius: 8px;
            padding: 5px 12px;
            transition: 0.2s;
        }

        .btn-outline-primary:hover {
            background-color: #324360 !important;
        }

        .btn-outline-danger {
            background-color: #ef4444 !important;
            color: #fff !important;
            border: none !important;
            border-radius: 8px;
            padding: 5px 12px;
            transition: 0.2s;
        }

        .btn-outline-danger:hover {
            background-color: #c53030 !important;
        }

        /* Modal */
        .modal-content {
            background: #1f2937;
            color: #f3f4f6;
            border-radius: 12px;
            border: 1px solid #374151;
        }

        .modal-header {
            background: #5672b3;
            color: #fff;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            border-bottom: 1px solid #374151;
        }

        .modal-footer {
            border-top: 1px solid #374151;
        }

        .modal-body hr {
            border-color: #374151;
        }

        .total-amount {
            font-weight: 700;
            color: #fbbf24;
        }

        .text-muted {
            color: #94a3b8 !important;
        }

        /* Toast container */
        .toast-body {
            color: #030303;
            background-color: #0ff175;
        }
        .toast-header {
            background-color: #57f15e;
            color: #000000;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="header-container" ng-include="'/html/header.html'"></div>

<!-- Toast container -->
<div class="position-fixed end-0 p-3" style="z-index: 1055; top: 70px;">
    <div id="toastContainer"></div>
</div>
<div class="container py-4">
    <h2 class="text-center mb-4">üõí ƒê∆°n h√†ng c·ªßa t√¥i</h2>

    <div class="card shadow-sm bg-dark border-0">
        <div class="card-body">
            <table class="table table-bordered align-middle text-center">
                <thead>
                <tr>
                    <th>ƒê·ªãa ch·ªâ giao</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="order in vm.orders">
                    <td>{{order.street || '-'}}</td>
                    <td>{{order.totalAmount | currency:'‚Ç´':0}}</td>
                    <td>
                        <span class="badge bg-warning text-dark" ng-if="order.status === 'PENDING'">Ch·ªù x√°c nh·∫≠n</span>
                        <span class="badge bg-success" ng-if="order.status === 'CONFIRMED'">ƒê√£ x√°c nh·∫≠n</span>
                        <span class="badge bg-info text-dark" ng-if="order.status === 'SHIPPING'">ƒêang giao h√†ng</span>
                        <span class="badge bg-primary" ng-if="order.status === 'SUCCESS'">Ho√†n th√†nh</span>
                        <span class="badge bg-danger" ng-if="order.status === 'CANCELLED'">ƒê√£ h·ªßy</span>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" ng-click="vm.viewDetails(order)">
                            üëÅ Xem
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-2"
                                ng-if="order.status === 'PENDING'"
                                ng-click="vm.cancelOrder(order)">
                            ‚ùå H·ªßy
                        </button>
                    </td>
                </tr>
                <tr ng-if="!vm.orders.length">
                    <td colspan="4" class="text-muted">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng #{{vm.selectedOrder.id}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" ng-if="vm.selectedOrder">
                    <p><strong>ƒê·ªãa ch·ªâ giao:</strong> {{vm.selectedOrder.address.street}}, {{vm.selectedOrder.address.city}}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong>
                        <span class="badge bg-warning text-dark" ng-if="vm.selectedOrder.status === 'PENDING'">Ch·ªù x√°c nh·∫≠n</span>
                        <span class="badge bg-success" ng-if="vm.selectedOrder.status === 'CONFIRMED'">ƒê√£ x√°c nh·∫≠n</span>
                        <span class="badge bg-info text-dark" ng-if="vm.selectedOrder.status === 'SHIPPING'">ƒêang giao h√†ng</span>
                        <span class="badge bg-primary" ng-if="vm.selectedOrder.status === 'SUCCESS'">Ho√†n th√†nh</span>
                        <span class="badge bg-danger" ng-if="vm.selectedOrder.status === 'CANCELLED'">ƒê√£ h·ªßy</span>
                    </p>
                    <hr>
                    <h6>Danh s√°ch s·∫£n ph·∫©m:</h6>
                    <!--                    <table class="table table-sm table-striped text-center">-->
                    <!--                        <thead>-->
                    <!--                        <tr>-->
                    <!--                            <th>T√™n s·∫£n ph·∫©m</th>-->
                    <!--                            <th>S·ªë l∆∞·ª£ng</th>-->
                    <!--                            <th>Gi√°</th>-->
                    <!--                            <th>T·ªïng</th>-->
                    <!--                        </tr>-->
                    <!--                        </thead>-->
                    <!--                        <tbody>-->
                    <!--                        <tr ng-repeat="item in vm.selectedOrder.items">-->
                    <!--                            <td>{{item.variantName}}</td>-->
                    <!--                            <td>{{item.qty}}</td>-->
                    <!--                            <td>{{item.price | currency:'‚Ç´':0}}</td>-->
                    <!--                            <td>{{item.qty * item.price | currency:'‚Ç´':0}}</td>-->
                    <!--                        </tr>-->
                    <!--                        </tbody>-->
                    <!--                    </table>-->

                    <table class="table table-sm table-striped text-center">
                        <thead>
                        <tr>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√°</th>
                            <th>T·ªïng</th>
                            <th>ƒê√°nh gi√°</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="item in vm.selectedOrder.items">
                            <td>{{item.variantName}}</td>
                            <td>{{item.qty}}</td>
                            <td>{{item.price | currency:'‚Ç´':0}}</td>
                            <td>{{item.qty * item.price | currency:'‚Ç´':0}}</td>

                            <td>
                                <!-- ‚≠ê Ch·ªâ hi·ªán n√∫t khi ƒë∆°n ƒë√£ ho√†n th√†nh -->
                                <button class="btn btn-warning btn-sm"
                                        ng-if="vm.selectedOrder.status === 'SUCCESS'"
                                        ng-click="vm.goReview(item)">
                                    ‚≠ê ƒê√°nh gi√°
                                </button>

                                <span class="text-muted"
                                      ng-if="vm.selectedOrder.status !== 'SUCCESS'">
                Ch·ªù giao
            </span>
                            </td>
                        </tr>
                        </tbody>
                    </table>


                    <div class="text-end fw-bold mt-3 total-amount">
                        T·ªïng c·ªông: {{vm.selectedOrder.totalAmount | currency:'‚Ç´':0}}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" ng-if="vm.selectedOrder.status === 'PENDING'"
                            ng-click="vm.cancelOrder(vm.selectedOrder)">
                        ‚ùå H·ªßy ƒë∆°n h√†ng
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    angular.module('appleShopApp', [])
        .controller('UserOrderController', ['$http', '$scope', function($http, $scope) {
            const vm = this;
            vm.orders = [];
            vm.selectedOrder = null;

            // ===== Load danh s√°ch ƒë∆°n h√†ng =====
            vm.loadOrders = function() {
                $http.get('http://localhost:8080/api/orders')
                    .then(resp => vm.orders = resp.data)
                    .catch(err => vm.showToast('‚ùå L·ªói khi t·∫£i ƒë∆°n h√†ng!', 'error'));
            };

            // ===== Xem chi ti·∫øt ƒë∆°n h√†ng =====
            vm.viewDetails = function(order) {
                $http.get(`http://localhost:8080/api/orders/${order.id}/variants`)
                    .then(resp => {
                        vm.selectedOrder = {
                            id: order.id,
                            totalAmount: order.totalAmount,
                            status: order.status,
                            address: { street: order.street, city: order.city },
                            items: resp.data
                        };
                        const modal = new bootstrap.Modal(document.getElementById('orderModal'));
                        modal.show();
                    })
                    .catch(err => vm.showToast('‚ùå L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng!', 'error'));
            };

            // ===== H·ªßy ƒë∆°n h√†ng =====
            vm.cancelOrder = function(order) {
                if (order.status !== 'PENDING') {
                    vm.showToast('‚ùå Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng ƒë√£ x√°c nh·∫≠n ho·∫∑c ƒëang giao.', 'error');
                    return;
                }
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) return;

                $http.put(`http://localhost:8080/api/orders/${order.id}/cancel`)
                    .then(resp => {
                        vm.showToast(resp.data.message, 'success');
                        vm.loadOrders();
                        if (vm.selectedOrder && vm.selectedOrder.id === order.id) {
                            vm.selectedOrder.status = 'CANCELLED';
                        }
                    })
                    .catch(err => vm.showToast('‚ùå L·ªói khi h·ªßy ƒë∆°n h√†ng!', 'error'));
            };

            // ===== Chuy·ªÉn sang ƒë√°nh gi√° s·∫£n ph·∫©m =====
            vm.goReview = function(item) {
                if (!item.variantId) {
                    vm.showToast("‚ùå Thi·∫øu th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ ƒë√°nh gi√°!", "error");
                    return;
                }

                window.location.href =
                    `/html/reviews.html?variantId=${item.variantId}`;
            };


            // ===== Toast th√¥ng b√°o =====
            vm.showToast = function(message, type='info') {
                const container = document.getElementById('toastContainer');
                if (!container) return;

                const toastEl = document.createElement('div');
                toastEl.className = 'toast align-items-center text-white border-0';
                toastEl.setAttribute('role', 'alert');
                toastEl.setAttribute('aria-live', 'assertive');
                toastEl.setAttribute('aria-atomic', 'true');
                toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

                container.appendChild(toastEl);
                const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 });
                bsToast.show();
                toastEl.addEventListener('hidden.bs.toast', () => container.removeChild(toastEl));
            };

            // ===== Kh·ªüi t·∫°o =====
            vm.loadOrders();
        }]);

</script>



<script src="/js/header.js"></script>
</body>
</html>

