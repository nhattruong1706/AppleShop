<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp">
<head>
    <meta charset="UTF-8">
    <title>H·ªì s∆° c√° nh√¢n | AppleShop</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

    <!-- FIX: Kh·ªüi t·∫°o module ch√≠nh (B·∫ÆT BU·ªòC) -->
    <script>
        // ƒê·ªãnh nghƒ©a module ch√≠nh 'appleShopApp' v·ªõi dependencies (hi·ªán t·∫°i l√† r·ªóng)
        angular.module('appleShopApp', []);
    </script>

    <script src="/js/profile-controller.js"></script>

    <style>
        /* CSS TO√ÄN TRANG: DARK THEME */
        body {
            background: linear-gradient(#0f1724, #111827); /* N·ªÅn t·ªëi gradient */
            color: #fff; /* M√†u ch·ªØ ch√≠nh */
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            padding-top: 40px;
        }
        .profile-container {
            max-width: 650px;
            margin: 50px auto;
        }
        /* Style cho card (H·ªì s∆° c√° nh√¢n) */
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6); /* B√≥ng t·ªëi h∆°n */
            background-color: #1f2937; /* N·ªÅn card t·ªëi */
            color: #fff;
        }
        h2, h3, h4 {
            font-weight: 600;
            color: #f3f4f6; /* M√†u ch·ªØ heading s√°ng */
        }
        label {
            font-weight: 500;
        }
        /* Style cho √¥ input (form-control) */
        .form-control {
            background-color: #0f172a;
            border-color: white;
            color: white;
        }
        .form-control:focus {
            background-color: #0f172a;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 0.25rem rgba(14, 165, 233, 0.25);
            color: white;
        }
        /* Primary buttons */
        .btn-primary {
            background-color: #0ea5e9;
            border-color: #0ea5e9;
        }
        .btn-primary:hover {
            background-color: #0c8cd6;
            border-color: #0c8cd6;
        }
        .btn-outline-primary {
            color: #0ea5e9;
            border-color: #0ea5e9;
        }
        .btn-outline-primary:hover {
            background-color: #0ea5e9;
            color: #fff;
        }
        .alert {
            border-radius: 10px;
        }
        /* Header specific styles */
        .site-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .dropdown-menu {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dropdown-item {
            color: #f3f4f6;
        }
        .dropdown-item:hover {
            background-color: #374151;
            color: #fff;
        }
    </style>
</head>
<body ng-controller="ProfileCtrl">

<!-- Header d√πng HeaderCtrl -->
<div ng-controller="HeaderCtrl as vm" class="site-container mb-4">
    <div class="d-flex justify-content-between align-items-center py-3">
        <!-- Logo + T√™n -->
        <a href="/html/index.html" class="d-flex align-items-center gap-3 text-decoration-none">
            <img src="/img/logo.png" alt="logo" style="height:48px;">
            <div>
                <h4 style="margin:0; color:#fff;">AppleShop</h4>
                <small style="color:#94a3b8;">S·∫£n ph·∫©m ch√≠nh h√£ng & ch·∫•t l∆∞·ª£ng</small>
            </div>
        </a>

        <!-- Search + User + Cart -->
        <div class="d-flex align-items-center gap-3">
            <!-- Search -->
            <div>
                <input type="text" class="form-control"
                       ng-model="vm.query"
                       ng-change="vm.debouncedFilter()"
                       placeholder="T√¨m ki·∫øm..." style="max-width: 250px; color: white;" />
            </div>

            <!-- User dropdown -->
            <div ng-if="vm.currentUser" class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Xin ch√†o, <b>{{vm.currentUser.username}}</b>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/html/profile.html">Trang c√° nh√¢n</a></li>
                    <li><a class="dropdown-item" href="/html/address.html">ƒê·ªãa ch·ªâ giao h√†ng</a></li>
                    <li><a class="dropdown-item" href="/html/my-order.html">ƒê∆°n h√†ng</a></li>
                    <li><a class="dropdown-item" href="/settings.html">C√†i ƒë·∫∑t</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="" ng-click="vm.logout()">ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>

            <!-- Login/Signup -->
            <div ng-if="!vm.currentUser">
                <a class="btn btn-outline-light btn-sm" href="/login.html">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</a>
            </div>

            <!-- Cart -->
            <div>
                <a href="/html/cart.html" class="btn btn-outline-light">Gi·ªè h√†ng</a>
            </div>
        </div>
    </div>
</div>
<div class="profile-container">
    <div class="text-center mb-4">
        <h2>üë§ H·ªì s∆° c√° nh√¢n</h2>
        <p  style="color: white">C·∫≠p nh·∫≠t th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
    </div>

    <!-- Th√¥ng b√°o -->
    <div ng-if="message" class="alert alert-success text-center" role="alert">
        {{message}}
    </div>
    <div ng-if="errorMessage" class="alert alert-danger text-center" role="alert">
        {{errorMessage}}
    </div>

    <!-- Th√¥ng tin c√° nh√¢n -->
    <div class="card p-4 mb-4">
        <h4 class="mb-3">Th√¥ng tin c∆° b·∫£n</h4>
        <form ng-submit="updateProfile()">
            <div class="mb-3">
                <label>H·ªç v√† t√™n</label>
                <input type="text" class="form-control" ng-model="user.fullName" required>
            </div>

            <div class="mb-3">
                <label>Email</label>
                <input type="email" class="form-control" ng-model="user.email" required>
            </div>

            <div class="mb-3">
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="text" class="form-control" ng-model="user.phone">
            </div>

            <div class="text-end">
                <button type="submit" class="btn btn-primary px-4">L∆∞u thay ƒë·ªïi</button>
            </div>
        </form>
    </div>

    <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
    <div class="card p-4">
        <h4 class="mb-3">ƒê·ªïi m·∫≠t kh·∫©u</h4>
        <div class="mb-3">
            <label>M·∫≠t kh·∫©u c≈©</label>
            <input type="password" class="form-control" ng-model="passwordData.oldPassword" required>
        </div>

        <div class="mb-3">
            <label>M·∫≠t kh·∫©u m·ªõi</label>
            <input type="password" class="form-control" ng-model="passwordData.newPassword" required>
        </div>

        <div class="text-end">
            <button class="btn btn-outline-primary px-4" ng-click="changePassword()">ƒê·ªïi m·∫≠t kh·∫©u</button>
        </div>

        <div ng-if="messagePwd" class="alert alert-info text-center mt-3">
            {{messagePwd}}
        </div>
    </div>
</div>
<script>
    angular.module('appleShopApp')
        .controller('HeaderCtrl', ['$http', '$window', '$timeout', function($http, $window, $timeout) {
            const vm = this;
            vm.currentUser = null;
            vm.query = '';
            let searchTimeout = null;

            // 1. Load th√¥ng tin user
            vm.loadUser = function() {
                $http.get('/api/auth/me', {withCredentials: true})
                    .then(resp => {
                        vm.currentUser = resp.data;
                        console.log('User load successful, data:', vm.currentUser);
                        // Log ƒë√£ cho th·∫•y user ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng
                    })
                    .catch(err => {
                        vm.currentUser = null;
                        console.error('Failed to load user info. Status:', err.status, 'Error data:', err.data);
                    });
            };

            // 2. Logout ng∆∞·ªùi d√πng
            vm.logout = function() {
                $http.post('/api/auth/logout', {}, {withCredentials: true})
                    .then(() => {
                        vm.currentUser = null;
                        $window.location.href = '/login.html';
                    })
                    .catch(err => console.error("L·ªói khi ƒëƒÉng xu·∫•t:", err));
            };

            // 3. H√†m gi·∫£ l·∫≠p cho debounce t√¨m ki·∫øm (ch∆∞a c√≥ ch·ª©c nƒÉng l·ªçc s·∫£n ph·∫©m)
            vm.debouncedFilter = function() {
                if (searchTimeout) $timeout.cancel(searchTimeout);
                searchTimeout = $timeout(() => {
                    // TODO: Tri·ªÉn khai logic l·ªçc s·∫£n ph·∫©m trong MainCtrl/Product Service
                    console.log('Search triggered with query:', vm.query);
                }, 300);
            };

            vm.init = function() {
                vm.loadUser();
            };

            vm.init();
        }]);

</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
