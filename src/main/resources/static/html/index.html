<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp">
<head>
    <meta charset="UTF-8">
    <title>AppleShop - Phụ kiện Apple</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        body { background: linear-gradient(#0f1724, #111827); color:#fff; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; padding:40px 0; }
        .site-container { max-width:1200px; margin:0 auto; }
        .hero { display:flex; gap:30px; align-items:center; margin-bottom:30px; flex-wrap:wrap; }
        .hero-card { flex:1; background: linear-gradient(135deg,#0b1220, #0b2b4a); border-radius:18px; padding:28px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
        .hero-card h1 { font-size:2.4rem; margin-bottom:10px; color:#fff; }
        .search-input { max-width:420px; position: relative; }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0b1220;
            border: 1px solid #1e293b;
            border-radius: 6px;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-suggestions li {
            padding: 8px 12px;
            cursor: pointer;
        }
        .search-suggestions li:hover {
            background: #111827;
        }
        .product-card { background: rgba(255,255,255,0.03); border-radius:12px; padding:16px; transition: transform .18s, box-shadow .18s; }
        .product-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.7); }
        .product-img { height:220px; width:100%; object-fit:contain; border-radius:10px; background-color:#0f1724; padding:10px; transition: transform .3s ease; }
        .product-card:hover .product-img { transform: scale(1.03); }
        .btn-apple { background:#111; color:#fff; border-radius:10px; padding:10px 14px; border:1px solid rgba(255,255,255,0.06); }
        .pagination .page-item.active .page-link { background-color: #0ea5e9; border-color: #0ea5e9; }
        .pagination .page-link { color: #e2e8f0; background-color:#0f1724; border:1px solid #1e293b; }
        .pagination .page-link:hover { background-color: #1e293b; }
    </style>
</head>
<body ng-controller="MainCtrl as vm">

<div class="site-container">

    <!-- Header -->
    <div class="site-container mb-4">
        <div class="d-flex justify-content-between align-items-center py-3">
            <!-- Logo + Tên -->
            <div class="d-flex align-items-center gap-3">
                <img src="/img/logo.png" alt="logo" style="height:48px;">
                <div>
                    <h4 style="margin:0; color:#fff;">AppleShop</h4>
                    <small style="color:#94a3b8;">Sản phẩm chính hãng & chất lượng</small>
                </div>
            </div>

            <!-- Search + User + Cart -->
            <div class="d-flex align-items-center gap-3">
                <div class="position-relative">
                    <input type="text" class="form-control search-input"
                           ng-model="vm.query"
                           ng-change="vm.searchProducts()"
                           placeholder="Tìm kiếm: AirPods, case, sạc..." />

                    <ul class="search-suggestions list-unstyled" ng-if="vm.suggestions.length">
                        <li ng-repeat="p in vm.suggestions" ng-click="vm.goToProduct(p)">
                            {{p.name}}
                        </li>
                    </ul>
                </div>

                <!-- User dropdown -->
                <div ng-if="vm.currentUser" class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        Xin chào, <b>{{vm.currentUser.username}}</b>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="/html/profile.html">Thay đổi thông tin</a></li>
                        <li><a class="dropdown-item" href="/html/address.html">Địa chỉ giao hàng</a></li>
                        <li><a class="dropdown-item" href="/html/my-order.html">Đơn hàng</a></li>
                        <li><a class="dropdown-item" href="/settings.html">Cài đặt</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="" ng-click="vm.logout()">Đăng xuất</a></li>
                    </ul>
                </div>

                <!-- Login/Signup -->
                <div ng-if="!vm.currentUser">
                    <a class="btn btn-outline-light btn-sm" href="/login.html">Đăng nhập / Đăng ký</a>
                </div>

                <!-- Cart -->
                <div>
                    <a href="/html/cart.html" class="btn btn-outline-light">
                        Giỏ hàng
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Carousel -->
    <div id="carouselExample" class="carousel slide mb-5" data-bs-ride="carousel" data-bs-interval="3000">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/87377e4d-029e-4407-7a78-2db0dcdf7c00/sddesktop" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/fd8beeb8-305a-44ac-7987-af898fe28d00/sddesktop" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/a63194b2-d97d-427c-a9f5-d248348e0a00/sddesktop" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/d97867bd-eeb7-40f3-1d1d-9b89368dbd00/sddesktop" class="d-block w-100" alt="...">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    <!-- Categories -->
    <div class="mb-3">
        <div class="d-flex gap-2 flex-wrap">
            <button type="button"
                    class="btn btn-sm"
                    ng-class="{'btn-info': vm.selectedCat==null, 'btn-outline-light': vm.selectedCat!=null}"
                    ng-click="vm.selectCategory(null)">
                Tất cả
            </button>

            <button type="button"
                    class="btn btn-sm"
                    ng-repeat="c in vm.categories"
                    ng-class="{'btn-info': vm.selectedCat==c.id, 'btn-outline-light': vm.selectedCat!=c.id}"
                    ng-click="vm.selectCategory(c.id)">
                {{c.name}}
            </button>
        </div>
    </div>

    <!-- Product grid -->
    <h3 class="text-white mb-3">Sản phẩm</h3>
    <div class="row g-3">
        <div class="col-md-4" ng-repeat="p in vm.paginatedProducts() | orderBy:'-id' track by p.id">
            <div class="product-card">
                <img ng-src="{{p.img || '/img/placeholder.jpg'}}"
                     alt="{{p.name}}"
                     class="product-img mb-2"
                     onerror="if (!this.dataset.error) { this.dataset.error = true; this.src='/img/placeholder.jpg'; }">
                <h5 style="color:#e6eef7;">{{p.name}}</h5>

                <div class="d-flex justify-content-between align-items-center">
                <span class="text-info fw-bold" style="color: red">
    {{ p.minPrice > 0 ? (p.minPrice | number:0) + ' đ' : 'Không có giá' }}
</span>


                    <div>
                        <button class="btn btn-sm btn-outline-light me-2" ng-click="vm.viewProduct(p)">Chi tiết</button>
                        <button class="btn btn-sm btn-apple"
                                ng-click="vm.addToCart(p)"
                                ng-disabled="p.stock<=0">
                            {{ p.stock>0 ? 'Thêm vào giỏ' : 'Hết hàng' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center align-items-center mt-4" ng-if="vm.totalPages() > 1">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item" ng-class="{disabled: vm.currentPage === 1}">
                    <a class="page-link" href="" ng-click="vm.goToPage(vm.currentPage - 1)">‹</a>
                </li>

                <li class="page-item"
                    ng-repeat="page in [].constructor(vm.totalPages()) track by $index"
                    ng-class="{active: vm.currentPage === ($index + 1)}">
                    <a class="page-link" href="" ng-click="vm.goToPage($index + 1)">
                        {{$index + 1}}
                    </a>
                </li>

                <li class="page-item" ng-class="{disabled: vm.currentPage === vm.totalPages()}">
                    <a class="page-link" href="" ng-click="vm.goToPage(vm.currentPage + 1)">›</a>
                </li>
            </ul>
        </nav>
    </div>

</div> <!-- site-container -->
<footer class="mt-5 py-5" style="background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.08);">
    <div class="site-container">
        <div class="row g-5">

            <!-- Cột 1: Logo + mô tả ngắn -->
            <div class="col-lg-4 col-md-6">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <img src="/img/logo.png" alt="AppleShop" style="height:48px; filter: brightness(0) invert(1);">
                    <h4 class="mb-0 text-white">AppleShop</h4>
                </div>
                <p class="text-slate-400 small lh-lg">
                    Chuyên phụ kiện & thiết bị Apple chính hãng<br>
                    AirPods · iPhone · iPad · MacBook · Apple Watch...
                </p>
                <div class="d-flex gap-3 mt-3">
                    <a href="#" class="text-white opacity-75 hover:opacity-100"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="text-white opacity-75 hover:opacity-100"><i class="fab fa-tiktok"></i></a>
                    <a href="#" class="text-white opacity-75 hover:opacity-100"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="text-white opacity-75 hover:opacity-100"><i class="fab fa-youtube"></i></a>
                </div>
            </div>

            <!-- Cột 2: Hỗ trợ khách hàng -->
            <div class="col-lg-2 col-md-6">
                <h6 class="mb-3 opacity-90">Hỗ trợ khách hàng</h6>
                <ul class="list-unstyled small opacity-75" style="line-height:2.1;">
                    <li>Chính sách bảo hành</li>
                    <li>Chính sách vận chuyển</li>
                    <li>Đổi trả & hoàn tiền</li>
                    <li>Cam kết chính hãng</li>
                    <li>Liên hệ & góp ý</li>
                </ul>
            </div>

            <!-- Cột 3: Về AppleShop -->
            <div class="col-lg-2 col-md-6">
                <h6 class="mb-3 opacity-90">Về AppleShop</h6>
                <ul class="list-unstyled small opacity-75" style="line-height:2.1;">
                    <li>Giới thiệu</li>
                    <li>Tuyển dụng</li>
                    <li>Tin tức & ưu đãi</li>
                    <li>Hệ thống cửa hàng</li>
                </ul>
            </div>

            <!-- Cột 4: Liên hệ & hotline -->
            <div class="col-lg-4 col-md-6">
                <h6 class="text-white fw-bold mb-3">Hotline miễn phí</h6>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-full w-12 h-12 d-flex align-items-center justify-content-center fw-bold">
                            <i class="fas fa-phone"></i>
                        </div>
                    </div>
                    <div>
                        <div class="text-sky-400 text-2xl fw-bold">0868552631</div>
                        <small class="text-slate-400">(8h30 - 21h30 hàng ngày)</small>
                    </div>
                </div>

                <p class="small text-slate-400 mb-2">
                    <i class="fas fa-envelope me-2"></i> support@appleshop.vn
                </p>
                <p class="small text-slate-400">
                    <i class="fas fa-map-marker-alt me-2"></i> 123 Nguyễn Trãi, Q.5, TP.HCM
                </p>

            </div>

        </div>

        <!-- Dòng copyright dưới cùng -->
        <hr class="my-4 border-slate-700">
        <div class="text-center small text-slate-500">
            © 2025 AppleShop.vn – Phụ kiện Apple chính hãng.
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    angular.module('appleShopApp', [])
        .controller('MainCtrl', ['$http', '$window', '$timeout', function($http, $window, $timeout) {
            const vm = this;
            vm.categories = [];
            vm.products = [];
            vm.filtered = [];
            vm.query = '';
            vm.suggestions = [];
            vm.currentUser = null;
            vm.currentPage = 1;
            vm.itemsPerPage = 9;
            vm.selectedCat = null;
            let searchTimeout = null;

            vm.init = function() {
                vm.loadProducts();
                vm.loadUser();
                vm.loadCategories();
            };

            vm.loadCategories = () => {
                $http.get('/api/categories')
                    .then(resp => vm.categories = resp.data)
                    .catch(() => vm.categories = []);
            };

            vm.selectCategory = id => {
                vm.selectedCat = id;
                vm.filterNow();
            };

            vm.loadUser = function() {
                $http.get('/api/auth/me', {withCredentials: true})
                    .then(resp => vm.currentUser = resp.data)
                    .catch(() => vm.currentUser = null);
            };

            vm.logout = function() {
                $http.post('/api/auth/logout', {}, {withCredentials: true})
                    .then(() => {
                        vm.currentUser = null;
                        $window.location.href = '/login.html';
                    });
            };

            // ======================================================
            // HÀM MỚI: LẤY GIÁ MIN TỪ BACKEND CHO MỖI SẢN PHẨM
            // ======================================================
            vm.loadMinPrices = async function() {
                for (let p of vm.products) {
                    try {
                        const res = await $http.get(`/api/variants/min-price/${p.id}`);
                        p.minPrice = res.data;  // backend chắc chắn trả về Double
                    } catch (e) {
                        p.minPrice = 0;
                    }
                }
            };

            // ============================
            // LOAD SẢN PHẨM
            // ============================
            vm.loadProducts = () => {
                $http.get('/api/products')
                    .then(async resp => {
                        vm.products = resp.data;

                        vm.filtered = vm.products.slice();

                        // ============================
                        // THÊM: GỌI HÀM LẤY GIÁ MIN
                        // ============================
                        vm.loadMinPrices();
                    });
            };

            // ===============================
            // Tìm kiếm với gợi ý xổ xuống
            // ===============================
            vm.searchProducts = function() {
                if(searchTimeout) $timeout.cancel(searchTimeout);
                searchTimeout = $timeout(() => {
                    const q = vm.query ? vm.query.toLowerCase() : '';
                    if(!q){
                        vm.suggestions = [];
                        return;
                    }
                    vm.suggestions = vm.products.filter(p =>
                        p.name?.toLowerCase().includes(q)
                    ).slice(0,10);
                }, 200);
            };

            vm.goToProduct = function(p) {
                $window.location.href = "/html/product-detail.html?id=" + p.id;
            };

            vm.debouncedFilter = function() {
                if (searchTimeout) $timeout.cancel(searchTimeout);
                searchTimeout = $timeout(vm.filterNow, 300);
            };

            // =========================================
            // Lọc sản phẩm theo text + category
            // =========================================
            vm.filterNow = function() {
                const q = vm.query ? vm.query.toLowerCase() : '';
                vm.filtered = vm.products.filter(p => {
                    const matchText =
                        !q || (p.name?.toLowerCase().includes(q)) || (p.description?.toLowerCase().includes(q));
                    const matchCategory =
                        !vm.selectedCat || p.category?.id === vm.selectedCat;
                    return matchText && matchCategory;
                });
                vm.currentPage = 1;
            };

            // =========================================
            // Giỏ hàng
            // =========================================
            vm.addToCart = function(p) {
                if(!vm.currentUser) return alert('Vui lòng đăng nhập trước.');
                alert("Vui lòng chọn phiên bản sản phẩm trong trang chi tiết!");
            };

            vm.viewProduct = function(p) {
                $window.location.href = "/html/product-detail.html?id=" + p.id;
            };

            // =========================================
            // Phân trang
            // =========================================
            vm.totalPages = function() {
                return Math.ceil(vm.filtered.length / vm.itemsPerPage) || 1;
            };

            vm.paginatedProducts = function() {
                const start = (vm.currentPage - 1) * vm.itemsPerPage;
                return vm.filtered.slice(start, start + vm.itemsPerPage);
            };

            vm.goToPage = function(page) {
                if(page >= 1 && page <= vm.totalPages()) vm.currentPage = page;
            };

            vm.init();
        }]);
</script>



</body>
</html>
