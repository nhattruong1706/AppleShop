<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp">
<head>
    <meta charset="UTF-8">
    <title>AppleShop - Ph·ª• ki·ªán Apple</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        body { background: linear-gradient(#0f1724, #111827); color:#fff; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; padding:40px 0; }
        .site-container { max-width:1200px; margin:0 auto; }
        .hero { display:flex; gap:30px; align-items:center; margin-bottom:30px; }
        .hero-card { flex:1; background: linear-gradient(135deg,#0b1220, #0b2b4a); border-radius:18px; padding:28px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
        .hero-card h1 { font-size:2.4rem; margin-bottom:10px; color:#fff; }
        .search-input { max-width:420px; }
        .category-list .nav-link { color:#cbd5e1; }
        .product-card { background: rgba(255,255,255,0.03); border-radius:12px; padding:16px; transition: transform .18s, box-shadow .18s; }
        .product-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.7); }
        .product-img { height:160px; object-fit:cover; border-radius:8px; width:100%; }
        .price { font-weight:700; color:#fff; }
        .btn-apple { background:#111; color:#fff; border-radius:10px; padding:10px 14px; border:1px solid rgba(255,255,255,0.06); }
        .cart-badge { background:#ff6b6b; color:#fff; padding:4px 8px; border-radius:12px; font-weight:700; }
        .category-active { background: linear-gradient(90deg,#0ea5e9,#0ea5e9); color:#012; border-radius:999px; padding:6px 12px; display:inline-block; }
    </style>
</head>
<body ng-controller="MainCtrl as vm">

<div class="site-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <img src="/img/logo.png" alt="logo" style="height:48px;">
            <div>
                <h4 style="margin:0;">AppleShop</h4>
                <small style="color:#94a3b8;">Ph·ª• ki·ªán ch√≠nh h√£ng & ch·∫•t l∆∞·ª£ng</small>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div>
                <input type="text" class="form-control search-input" ng-model="vm.query" ng-change="vm.filter()" placeholder="T√¨m ki·∫øm: AirPods, case, s·∫°c..." />
            </div>

            <div ng-if="vm.currentUser" class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    Xin ch√†o, <b>{{vm.currentUser.username}}</b>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="/profile.html">Trang c√° nh√¢n</a></li>
                    <li><a class="dropdown-item" href="/settings.html">C√†i ƒë·∫∑t</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="" ng-click="vm.logout()">ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>

            <div ng-if="!vm.currentUser">
                <a class="btn btn-outline-light btn-sm" href="/login.html">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</a>
            </div>

            <div>
                <button class="btn btn-outline-light" ng-click="vm.openCart()">
                    Gi·ªè h√†ng <span class="cart-badge" ng-show="vm.cartCount">{{vm.cartCount}}</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Hero -->
    <div class="hero mb-4">
        <div class="hero-card">
            <h1>Ph·ª• ki·ªán Apple ‚Äî Sang tr·ªçng. B·ªÅn b·ªâ. Ch√≠nh h√£ng.</h1>
            <p style="color:#cbd5e1;">Magsafe, D√¢y ƒë·ªìng h·ªì, Case, Tai nghe & m·ªçi th·ª© b·∫°n c·∫ßn cho thi·∫øt b·ªã Apple.</p>
        </div>
        <div style="width:380px;">
            <img src="/img/hero_right.png" style="width:100%; border-radius:14px; box-shadow:0 20px 40px rgba(2,6,23,0.7);" alt="hero">
        </div>
    </div>

    <!-- Categories -->
    <div class="mb-3">
        <div class="d-flex gap-2 category-list">
            <a href="#" ng-class="{'category-active': vm.selectedCat==null}" ng-click="vm.selectCategory(null)">T·∫•t c·∫£</a>
            <a ng-repeat="c in vm.categories" href="#" ng-click="vm.selectCategory(c.id)" ng-class="{'category-active': vm.selectedCat==c.id}">{{c.name}}</a>
        </div>
    </div>

    <!-- Product grid -->
    <div class="row g-3">
        <div class="col-md-4" ng-repeat="p in vm.filtered | orderBy:'-id'">
            <div class="product-card">
                <img ng-src="{{p.img || '/img/products/placeholder.jpg'}}" alt="{{p.name}}" class="product-img mb-2" />
                <h5 style="color:#e6eef7;">{{p.name}}</h5>
                <p style="color:#9aa7b8; min-height:36px;">{{p.description}}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="price">{{p.price | number:0}}‚Ç´</div>
                    <div>
                        <button class="btn btn-sm btn-outline-light me-2" ng-click="vm.viewProduct(p)">Chi ti·∫øt</button>
                        <button class="btn btn-sm btn-apple" ng-click="vm.addToCart(p)" ng-disabled="p.stock<=0">
                            {{ p.stock>0 ? 'Th√™m v√†o gi·ªè' : 'H·∫øt h√†ng' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> <!-- ƒê√≥ng site-container -->

<!-- Cart Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">üõí Gi·ªè h√†ng</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div ng-if="vm.cart.length === 0" class="text-center text-muted">Gi·ªè h√†ng tr·ªëng.</div>
        <div ng-if="vm.cart.length > 0">
            <div ng-repeat="item in vm.cart" class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                    <strong>{{item.product.name}}</strong><br/>
                    <small class="text-muted">{{item.qty}} x {{item.product.price | number:0}}‚Ç´</small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" ng-click="vm.changeQty(item, item.qty-1)">-</button>
                    <button class="btn btn-sm btn-outline-secondary" ng-click="vm.changeQty(item, item.qty+1)">+</button>
                    <button class="btn btn-sm btn-outline-danger" ng-click="vm.removeItem(item)">üóë</button>
                </div>
            </div>
            <hr/>
            <div class="d-flex justify-content-between">
                <strong>T·ªïng c·ªông:</strong>
                <strong>{{vm.total() | number:0}}‚Ç´</strong>
            </div>
            <div class="mt-3">
                <button class="btn btn-success w-100" ng-click="vm.checkout()">Thanh to√°n</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    angular.module('appleShopApp', [])
        .controller('MainCtrl', ['$http','$window', function($http,$window){
            const vm = this;
            vm.categories = [];
            vm.products = [];
            vm.filtered = [];
            vm.selectedCat = null;
            vm.query = '';
            vm.currentUser = null;
            vm.cart = [];
            vm.cartCount = 0;

            vm.init = function() {
                vm.loadCategories();
                vm.loadProducts();
                vm.loadUser();
            };

            // User
            vm.loadUser = function() {
                $http.get('/api/auth/me', {withCredentials:true})
                    .then(resp => {
                        vm.currentUser = resp.data;
                        vm.loadCart(); // load cart khi c√≥ user
                    })
                    .catch(err => console.error("Kh√¥ng th·ªÉ l·∫•y user:", err));
            };
            vm.logout = function() {
                $http.post('/api/auth/logout', {}, {withCredentials:true})
                    .then(() => { vm.currentUser = null; $window.location.href = '/login.html'; });
            };

            // Categories & Products
            vm.loadCategories = () => $http.get('/api/categories').then(resp=>vm.categories=resp.data);
            vm.loadProducts = () => $http.get('/api/products').then(resp=>{
                vm.products = resp.data;
                vm.filtered = vm.products.slice();
            });

            // Filter
            vm.selectCategory = id=>{ vm.selectedCat=id; vm.filter(); };
            vm.filter = ()=> {
                const q = vm.query ? vm.query.toLowerCase() : '';
                vm.filtered = vm.products.filter(p=>{
                    const matchesQ = !q || (p.name && p.name.toLowerCase().includes(q)) || (p.description && p.description.toLowerCase().includes(q));
                    const matchesCat = vm.selectedCat==null || p.category_id==vm.selectedCat;
                    return matchesQ && matchesCat;
                });
            };

            // Product details
            vm.viewProduct = p=> alert(p.name+'\n\n'+(p.description||'Kh√¥ng c√≥ m√¥ t·∫£.'));

            // Cart APIs
            vm.loadCart = function(){
                if(!vm.currentUser) return;
                $http.get('/api/cart/items', {withCredentials:true})
                    .then(resp => { vm.cart = resp.data; vm.updateCartCount(); })
                    .catch(err => console.error('Kh√¥ng load ƒë∆∞·ª£c gi·ªè:', err));
            };

            vm.addToCart = function(p){
                if(!vm.currentUser){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi th√™m gi·ªè'); return; }
                const f = vm.cart.find(i=>i.product.id===p.id);
                const qty = f ? f.qty + 1 : 1;
                $http.post('/api/cart/items', { productId: p.id, qty: qty }, {withCredentials:true})
                    .then(resp=>{
                        const updated = resp.data;
                        const idx = vm.cart.findIndex(i=>i.product.id===p.id);
                        if(idx>=0) vm.cart[idx] = updated;
                        else vm.cart.push(updated);
                        vm.updateCartCount();
                    })
                    .catch(err=>console.error('Kh√¥ng th√™m ƒë∆∞·ª£c v√†o gi·ªè:', err));
            };

            vm.changeQty = function(item,newQty){
                if(newQty<=0){
                    $http.delete('/api/cart/items/'+item.id, {withCredentials:true})
                        .then(()=> { vm.cart = vm.cart.filter(i=>i.id!==item.id); vm.updateCartCount(); })
                        .catch(err=>console.error('Kh√¥ng x√≥a ƒë∆∞·ª£c:',err));
                } else {
                    $http.post('/api/cart/items', { productId: item.product.id, qty: newQty }, {withCredentials:true })
                        .then(resp=>{ item.qty = resp.data.qty; vm.updateCartCount(); })
                        .catch(err=>console.error('Kh√¥ng update ƒë∆∞·ª£c:',err));
                }
            };

            vm.openCart = function(){
                if(vm.currentUser) vm.loadCart();
                new bootstrap.Offcanvas(document.getElementById('cartCanvas')).show();
            };

            vm.updateCartCount = ()=> vm.cartCount = vm.cart.reduce((s,i)=>s+i.qty,0);
            vm.total = ()=> vm.cart.reduce((s,i)=>s+(i.product.price*i.qty),0);
            vm.checkout = ()=> {
                if(!vm.currentUser){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n.'); return; }
                alert('Demo: g·ªçi API thanh to√°n. T·ªïng: '+vm.total()+'‚Ç´');
            };

            vm.init();
        }]);
</script>

</body>
</html>
