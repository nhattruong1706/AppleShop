<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp">
<head>
    <meta charset="UTF-8">
    <title>AppleShop - Ph·ª• ki·ªán Apple</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        body { background: linear-gradient(#0f1724, #111827); color:#fff; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; padding:40px 0; }
        .site-container { max-width:1200px; margin:0 auto; }
        .hero { display:flex; gap:30px; align-items:center; margin-bottom:30px; flex-wrap:wrap; }
        .hero-card { flex:1; background: linear-gradient(135deg,#0b1220, #0b2b4a); border-radius:18px; padding:28px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
        .hero-card h1 { font-size:2.4rem; margin-bottom:10px; color:#fff; }
        .search-input { max-width:420px; }
        .product-card { background: rgba(255,255,255,0.03); border-radius:12px; padding:16px; transition: transform .18s, box-shadow .18s; }
        .product-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.7); }
        .product-img { height:220px; width:100%; object-fit:contain; border-radius:10px; background-color:#0f1724; padding:10px; transition: transform .3s ease; }
        .product-card:hover .product-img { transform: scale(1.03); }
        .btn-apple { background:#111; color:#fff; border-radius:10px; padding:10px 14px; border:1px solid rgba(255,255,255,0.06); }
        .pagination .page-item.active .page-link { background-color: #0ea5e9; border-color: #0ea5e9; }
        .pagination .page-link { color: #e2e8f0; background-color:#0f1724; border:1px solid #1e293b; }
        .pagination .page-link:hover { background-color: #1e293b; }
    </style>
</head>
<body ng-controller="MainCtrl as vm">

<div class="site-container">

    <!-- Header -->
    <div class="site-container mb-4">
        <div class="d-flex justify-content-between align-items-center py-3">
            <!-- Logo + T√™n -->
            <div class="d-flex align-items-center gap-3">
                <img src="/img/logo.png" alt="logo" style="height:48px;">
                <div>
                    <h4 style="margin:0; color:#fff;">AppleShop</h4>
                    <small style="color:#94a3b8;">Ph·ª• ki·ªán ch√≠nh h√£ng & ch·∫•t l∆∞·ª£ng</small>
                </div>
            </div>

            <!-- Search + User + Cart -->
            <div class="d-flex align-items-center gap-3">
                <div>
                    <input type="text" class="form-control search-input"
                           ng-model="vm.query"
                           ng-change="vm.debouncedFilter()"
                           placeholder="T√¨m ki·∫øm: AirPods, case, s·∫°c..." />
                </div>

                <!-- User dropdown -->
                <div ng-if="vm.currentUser" class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        Xin ch√†o, <b>{{vm.currentUser.username}}</b>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="/profile.html">Trang c√° nh√¢n</a></li>
                        <li><a class="dropdown-item" href="/settings.html">C√†i ƒë·∫∑t</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="" ng-click="vm.logout()">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </div>

                <!-- Login/Signup -->
                <div ng-if="!vm.currentUser">
                    <a class="btn btn-outline-light btn-sm" href="/login.html">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</a>
                </div>

                <!-- Cart -->
                <div>
                    <a href="/html/cart.html" class="btn btn-outline-light">
                        Gi·ªè h√†ng
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Carousel -->
    <div id="carouselExample" class="carousel slide mb-5" data-bs-ride="carousel" data-bs-interval="3000">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/87377e4d-029e-4407-7a78-2db0dcdf7c00/sddesktop" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/fd8beeb8-305a-44ac-7987-af898fe28d00/sddesktop" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/a63194b2-d97d-427c-a9f5-d248348e0a00/sddesktop" class="d-block w-100" alt="...">
            </div>
            <div class="carousel-item">
                <img src="https://imagedelivery.net/pcfIh3eYwfdNQBLIm8PT-Q/d97867bd-eeb7-40f3-1d1d-9b89368dbd00/sddesktop" class="d-block w-100" alt="...">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>



    <div class="mb-3">
        <div class="d-flex gap-2 flex-wrap">
            <!-- T·∫•t c·∫£ -->
            <button type="button"
                    class="btn btn-sm"
                    ng-class="{'btn-info': vm.selectedCat==null, 'btn-outline-light': vm.selectedCat!=null}"
                    ng-click="vm.selectCategory(null)">
                T·∫•t c·∫£
            </button>

            <!-- C√°c category -->
            <button type="button"
                    class="btn btn-sm"
                    ng-repeat="c in vm.categories"
                    ng-class="{'btn-info': vm.selectedCat==c.id, 'btn-outline-light': vm.selectedCat!=c.id}"
                    ng-click="vm.selectCategory(c.id)">
                {{c.name}}
            </button>
        </div>
    </div>

    <!-- Product grid -->
    <h3 class="text-white mb-3">S·∫£n ph·∫©m</h3>
    <div class="row g-3">
        <div class="col-md-4" ng-repeat="p in vm.paginatedProducts() | orderBy:'-id' track by p.id">
            <div class="product-card">
                <img ng-src="{{p.img || '/img/placeholder.jpg'}}"
                     alt="{{p.name}}"
                     class="product-img mb-2"
                     onerror="if (!this.dataset.error) { this.dataset.error = true; this.src='/img/placeholder.jpg'; }">
                <h5 style="color:#e6eef7;">{{p.name}}</h5>
                <p style="color:#9aa7b8; min-height:36px;">{{p.description}}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="price">{{p.price | number:0}}‚Ç´</div>
                    <div>
                        <button class="btn btn-sm btn-outline-light me-2" ng-click="vm.viewProduct(p)">Chi ti·∫øt</button>
                        <button class="btn btn-sm btn-apple"
                                ng-click="vm.addToCart(p)"
                                ng-disabled="p.stock<=0">
                            {{ p.stock>0 ? 'Th√™m v√†o gi·ªè' : 'H·∫øt h√†ng' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center align-items-center mt-4" ng-if="vm.totalPages() > 1">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item" ng-class="{disabled: vm.currentPage === 1}">
                    <a class="page-link" href="" ng-click="vm.goToPage(vm.currentPage - 1)">‚Äπ</a>
                </li>

                <li class="page-item"
                    ng-repeat="page in [].constructor(vm.totalPages()) track by $index"
                    ng-class="{active: vm.currentPage === ($index + 1)}">
                    <a class="page-link" href="" ng-click="vm.goToPage($index + 1)">
                        {{$index + 1}}
                    </a>
                </li>

                <li class="page-item" ng-class="{disabled: vm.currentPage === vm.totalPages()}">
                    <a class="page-link" href="" ng-click="vm.goToPage(vm.currentPage + 1)">‚Ä∫</a>
                </li>
            </ul>
        </nav>
    </div>

</div> <!-- site-container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    angular.module('appleShopApp', [])
        .controller('MainCtrl', ['$http', '$window', '$timeout', function($http, $window, $timeout) {
            const vm = this;
            vm.categories = [];
            vm.products = [];
            vm.filtered = [];
            vm.query = '';
            vm.currentUser = null;
            vm.currentPage = 1;
            vm.itemsPerPage = 9;
            vm.selectedCat = null;
            let searchTimeout = null;

            vm.init = function() {
                vm.loadProducts();
                vm.loadUser();
                vm.loadCategories();
            };

            // üì¶ Load danh m·ª•c
            vm.loadCategories = () => {
                $http.get('/api/categories')
                    .then(resp => vm.categories = resp.data)
                    .catch(() => vm.categories = []);
            };

            // üì¶ Ch·ªçn danh m·ª•c
            vm.selectCategory = id => {
                vm.selectedCat = id;
                vm.filterNow();
            };

            // üë§ Load th√¥ng tin user
            vm.loadUser = function() {
                $http.get('/api/auth/me', {withCredentials: true})
                    .then(resp => vm.currentUser = resp.data)
                    .catch(() => vm.currentUser = null);
            };

            // üö™ Logout
            vm.logout = function() {
                $http.post('/api/auth/logout', {}, {withCredentials: true})
                    .then(() => {
                        vm.currentUser = null;
                        $window.location.href = '/login.html';
                    });
            };

            // üõí Load s·∫£n ph·∫©m
            vm.loadProducts = () => {
                $http.get('/api/products')
                    .then(resp => {
                        vm.products = resp.data;
                        vm.filtered = vm.products.slice();
                    });
            };

            // ‚è≥ Debounce t√¨m ki·∫øm
            vm.debouncedFilter = function() {
                if (searchTimeout) $timeout.cancel(searchTimeout);
                searchTimeout = $timeout(vm.filterNow, 300);
            };

            // üîç L·ªçc s·∫£n ph·∫©m theo t·ª´ kh√≥a v√† danh m·ª•c
            vm.filterNow = function() {
                const q = vm.query ? vm.query.toLowerCase() : '';

                vm.filtered = vm.products.filter(p => {
                    const matchText =
                        !q || (p.name?.toLowerCase().includes(q)) || (p.description?.toLowerCase().includes(q));

                    const matchCategory =
                        !vm.selectedCat || p.category?.id === vm.selectedCat;

                    return matchText && matchCategory;
                });

                vm.currentPage = 1;
            };

            // üõí Th√™m gi·ªè h√†ng
            vm.addToCart = function(p) {
                if (!vm.currentUser) return alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.');
                $http.post('/api/cart/add', null, {
                    params: { variantId: p.id, qty: 1 },
                    withCredentials: true
                }).then(() => alert('‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!'));
            };

            // üëÄ Xem chi ti·∫øt
            vm.viewProduct = function(p) {
                $window.location.href = "/html/product-detail.html?id=" + p.id;
            };

            // üìÑ Ph√¢n trang
            vm.totalPages = function() {
                return Math.ceil(vm.filtered.length / vm.itemsPerPage) || 1;
            };

            vm.paginatedProducts = function() {
                const start = (vm.currentPage - 1) * vm.itemsPerPage;
                return vm.filtered.slice(start, start + vm.itemsPerPage);
            };

            vm.goToPage = function(page) {
                if (page >= 1 && page <= vm.totalPages()) vm.currentPage = page;
            };

            vm.init();
        }]);
</script>


</body>
</html>
