<!DOCTYPE html>
<html lang="vi" ng-app="appleShopApp" ng-controller="ProductDetailController as vm">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

    <style>
        /* ====== T·ªïng th·ªÉ ====== */
        body {
            background: linear-gradient(145deg, #0f1724, #111827);
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            padding: 40px 0;
        }

        .site-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-input {
            max-width: 420px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            transition: 0.3s;
        }
        .search-input::placeholder {
            color: #94a3b8;
        }
        .search-input:focus {
            background: #fff;
            color: #111;
        }

        /* ====== Khung chi ti·∫øt s·∫£n ph·∫©m ====== */
        .product-detail {
            background: #ffffff;
            color: #222;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 35px;
            transition: all 0.3s ease;
        }
        .product-detail:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 30px rgba(0, 0, 0, 0.2);
        }

        /* ====== ·∫¢nh s·∫£n ph·∫©m ====== */
        .product-detail img {
            width: 100%;
            max-width: 360px;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        .product-detail img:hover {
            transform: scale(1.03);
        }

        /* ====== Ti√™u ƒë·ªÅ v√† gi√° ====== */
        .product-detail h2 {
            font-weight: 700;
            color: #111;
            margin-bottom: 10px;
        }
        .product-detail p {
            color: #666;
            font-size: 0.95rem;
        }
        .product-detail h4 {
            color: #e63946;
            margin-top: 15px;
            font-weight: 700;
        }

        /* ====== N√∫t ch·ªçn m√†u s·∫Øc ====== */
        .color-btn {
            margin: 5px;
            padding: 8px 18px;
            border-radius: 8px;
            border: 1px solid #333;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.25s;
        }
        .color-btn.selected-color {
            background-color: #333;
            color: white;
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.15);
        }
        .color-btn:hover {
            background: #333;
            color: white;
        }

        /* ====== N√∫t ch·ªçn dung l∆∞·ª£ng ====== */
        .storage-btn {
            margin: 5px;
            padding: 8px 18px;
            border-radius: 8px;
            border: 1px solid #007bff;
            background-color: #fff;
            color: #007bff;
            cursor: pointer;
            transition: all 0.25s;
        }
        .storage-btn.selected-storage {
            background-color: #007bff;
            color: #fff;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .storage-btn:hover {
            background-color: #007bff;
            color: #fff;
        }

        /* ====== Input s·ªë l∆∞·ª£ng ====== */
        .qty-input {
            width: 80px;
            padding: 6px;
            text-align: center;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-weight: 500;
            transition: 0.2s;
        }
        .qty-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        /* ====== N√∫t th√™m gi·ªè h√†ng ====== */
        .add-to-cart {
            margin-top: 25px;
            padding: 10px 24px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
        }
        .add-to-cart:hover {
            background: linear-gradient(135deg, #27ae60, #219150);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(39, 174, 96, 0.4);
        }

        /* ====== M√¥ t·∫£ chi ti·∫øt ====== */
        .description-box {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .description-box h5 {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .description-box p {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.7;
        }

        /* ====== Responsive ====== */
        @media (max-width: 768px) {
            .product-detail {
                padding: 20px;
            }
            .product-detail img {
                max-width: 100%;
            }
            .add-to-cart {
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-light">

<!-- Header -->
<div class="site-container mb-4">
    <div class="d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center gap-3">
            <img src="/img/logo.png" alt="logo" style="height:48px;">
            <div>
                <h4 style="margin:0; color:#fff;">AppleShop</h4>
                <small style="color:#94a3b8;">Ph·ª• ki·ªán ch√≠nh h√£ng & ch·∫•t l∆∞·ª£ng</small>
            </div>
        </div>

        <div class="d-flex align-items-center gap-3">
            <div>
                <input type="text" class="form-control search-input"
                       ng-model="vm.query"
                       ng-change="vm.debouncedFilter()"
                       placeholder="T√¨m ki·∫øm: AirPods, case, s·∫°c..." />
            </div>

            <div ng-if="vm.currentUser" class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    Xin ch√†o, <b>{{vm.currentUser.username}}</b>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="/profile.html">Trang c√° nh√¢n</a></li>
                    <li><a class="dropdown-item" href="/settings.html">C√†i ƒë·∫∑t</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="" ng-click="vm.logout()">ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>

            <div ng-if="!vm.currentUser">
                <a class="btn btn-outline-light btn-sm" href="/login.html">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</a>
            </div>

            <div>
                <a href="/html/cart.html" class="btn btn-outline-light">
                    Gi·ªè h√†ng
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5 product-detail" ng-if="vm.product" style="max-width: 900px;">
    <div class="row">
        <div class="col-md-5 text-center">
            <img ng-src="{{vm.API_BASE + (vm.selectedVariant && vm.selectedVariant.img ? vm.selectedVariant.img : vm.product.img)}}"
                 alt="{{vm.product.name}}">
        </div>

        <div class="col-md-7">
            <h2>{{vm.product.name}}</h2>
            <p>{{vm.product.shortDescription}}</p>

            <h4>{{vm.selectedVariant.price | currency:"":0}}‚Ç´</h4>

            <div class="mt-3">
                <label style="font-weight:600;">M√†u s·∫Øc:</label><br>
                <button ng-repeat="variant in vm.variants | unique:'color'"
                        ng-click="vm.selectColor(variant.color)"
                        ng-class="{'selected-color': vm.selectedColor === variant.color}"
                        class="color-btn">
                    {{variant.color}}
                </button>
            </div>

            <div class="mt-3" ng-if="vm.storages.length > 0">
                <label style="font-weight:600;">Dung l∆∞·ª£ng:</label><br>
                <button ng-repeat="s in vm.storages"
                        ng-click="vm.selectStorage(s)"
                        ng-class="{'selected-storage': vm.selectedStorage === s}"
                        class="storage-btn">
                    {{s}}
                </button>
            </div>

            <div style="margin-top:20px;">
                <label style="font-weight:600;">S·ªë l∆∞·ª£ng:</label>
                <input type="number"
                       ng-model="vm.qty"
                       min="1"
                       max="{{vm.selectedVariant ? vm.selectedVariant.stock : vm.product.stock}}"
                       class="qty-input"
                       ng-change="vm.validateQty()">
                <span style="margin-left:10px; color:#555;">
                    T·ªìn kho: {{vm.selectedVariant ? vm.selectedVariant.stock : vm.product.stock}}
                </span>
            </div>

            <button ng-click="vm.addToCart()" class="add-to-cart">
                üõí Th√™m v√†o gi·ªè h√†ng
            </button>

            <div class="description-box">
                <h5>M√¥ t·∫£ s·∫£n ph·∫©m</h5>
                <p>{{vm.product.description}}</p>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-5" ng-if="!vm.product">
    <p style="color:#777; font-size:1rem;">ƒêang t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m...</p>
</div>

<script>
    const app = angular.module("appleShopApp", []);
    app.controller("ProductDetailController", function ($http) {
        const vm = this;
        vm.qty = 1;
        vm.selectedVariantId = null;
        vm.selectedColor = null;
        vm.selectedStorage = null;
        vm.storages = [];
        vm.variants = [];
        vm.API_BASE = 'http://localhost:8080';
        vm.currentUser = null;

        vm.loadUser = function() {
            $http.get('/api/auth/me', {withCredentials: true})
                .then(resp => vm.currentUser = resp.data)
                .catch(() => vm.currentUser = null);
        };
        vm.loadUser();

        vm.logout = function() {
            $http.post('/api/auth/logout', {}, {withCredentials: true})
                .then(() => {
                    vm.currentUser = null;
                    window.location.href = '/login.html';
                });
        };

        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id");

        $http.get(`/api/products/${productId}`).then(res => vm.product = res.data);
        $http.get(`/api/variants/product/${productId}`).then(res => {
            vm.variants = res.data;
            if (vm.variants.length > 0) {
                vm.selectedColor = vm.variants[0].color;
                vm.loadStorages(vm.selectedColor);
            }
        });

        vm.selectColor = function (color) {
            vm.selectedColor = color;
            vm.loadStorages(color);
            vm.selectedStorage = null;
            vm.selectedVariantId = null;
        };

        vm.validateQty = function() {
            if (!vm.selectedVariant) return;
            if (vm.qty > vm.selectedVariant.stock) {
                alert("‚ö†Ô∏è S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!");
                vm.qty = vm.selectedVariant.stock;
            }
        };

        vm.loadStorages = function (color) {
            vm.storages = vm.variants
                .filter(v => v.color === color)
                .map(v => v.storage)
                .filter((v, i, arr) => arr.indexOf(v) === i);
        };

        vm.selectStorage = function (storage) {
            vm.selectedStorage = storage;
            if (vm.selectedColor && vm.selectedStorage) {
                vm.getVariantIdFromServer();
            }
        };

        vm.getVariantIdFromServer = function () {
            const url = `/api/variants/find?productId=${productId}&color=${encodeURIComponent(vm.selectedColor)}&storage=${encodeURIComponent(vm.selectedStorage)}`;
            $http.get(url)
                .then(res => {
                    vm.selectedVariantId = res.data.id;
                    vm.selectedVariant = res.data;
                })
                .catch(() => {
                    vm.selectedVariantId = null;
                    vm.selectedVariant = null;
                });
        };

        vm.addToCart = function () {
            if (!vm.selectedVariantId) {
                alert("‚ùó Vui l√≤ng ch·ªçn m√†u v√† dung l∆∞·ª£ng tr∆∞·ªõc khi th√™m v√†o gi·ªè h√†ng!");
                return;
            }
            $http.post(`/api/cart/add?variantId=${vm.selectedVariantId}&qty=${vm.qty}`)
                .then(() => alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng!"))
                .catch(() => alert("‚ùå L·ªói khi th√™m v√†o gi·ªè h√†ng!"));
        };
    });

    app.filter('unique', function () {
        return function (items, field) {
            const seen = {};
            return items.filter(item => {
                const val = item[field];
                return seen.hasOwnProperty(val) ? false : (seen[val] = true);
            });
        };
    });
</script>
</body>
</html>
